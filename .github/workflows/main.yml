name: Publish NuGet Package

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

env:
  CONFIGURATION: Release
  PACKAGE_OUTPUT_DIRECTORY: output

jobs:
  build-pack-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0   # REQUIRED for MinVer

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x

      - name: Restore
        run: dotnet restore Meadow_Framework.sln

      # ✅ IMPORTANT: build the SOLUTION (analyzer included)
      - name: Build
        run: |
          dotnet build Meadow_Framework.sln \
            --configuration $CONFIGURATION \
            --no-restore

      # ✅ Pack ONLY the main project (no --no-build!)
      - name: Pack
        run: |
          mkdir -p $PACKAGE_OUTPUT_DIRECTORY
          dotnet pack Meadow_Framework/Meadow_Framework.csproj \
            --configuration $CONFIGURATION \
            --no-restore \
            --output $PACKAGE_OUTPUT_DIRECTORY

      # (optional) list artifacts for debugging
      - name: List packages
        run: ls -la $PACKAGE_OUTPUT_DIRECTORY

      - name: Publish to GitHub Packages
        run: |
          dotnet nuget push "$PACKAGE_OUTPUT_DIRECTORY/*.nupkg" \
            --api-key ${{ secrets.GITHUB_TOKEN }} \
            --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json
