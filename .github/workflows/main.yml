name: CI/CD Release

on:
  push:
    branches:
      - master
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:

  env:
    PROJECT_PATH: Meadow_Framework/Meadow_Framework.csproj
    PROJECT_ANALYZER_PATH: Meadow_Framework/Meadow_Framework.Analyzer.csproj
    TEST_PROJECT_PATH: Meadow_Framework.Tests/Meadow_Framework.Tests.csproj
    PACKAGE_OUTPUT_DIRECTORY: ${{ github.workspace }}/output
    GITHUB_NUGET_SOURCE: https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json

  jobs:
    release:
      runs-on: ubuntu-latest
      timeout-minutes: 30

      permissions:
        contents: write
        packages: write
        deployments: write

      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Log start
          run: echo "[CI/CD] Workflow started on $GITHUB_REF"

        # ---------------- VERSION ----------------

        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: "22"

        - name: Install semantic-release
          run: |
            npm install --no-save semantic-release \
              @semantic-release/commit-analyzer \
              @semantic-release/release-notes-generator \
              @semantic-release/github \
              @semantic-release/exec

        - name: Determine VERSION
          id: version
          run: |
            SEMVER_OUTPUT=$(npx semantic-release --branches master --dry-run --ci 2>&1 || true)
            VERSION=$(echo "$SEMVER_OUTPUT" | grep "Next release version" | awk '{print $4}')
            
            if [ -z "$VERSION" ]; then
              LATEST_TAG=$(git tag --sort=-creatordate | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1 || echo "v0.0.0")
              IFS='.' read -r MAJOR MINOR PATCH <<< "${LATEST_TAG#v}"
              VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
            fi
            
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "version=$VERSION" >> $GITHUB_OUTPUT

        - name: Create Git tag
          if: "!startsWith(github.ref, 'refs/tags/')"
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
            git push origin "v${{ steps.version.outputs.version }}"

        # ---------------- .NET ----------------

        - name: Setup .NET
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: "9.0.x"

        - name: Restore
          run: |
            dotnet restore ${{ env.PROJECT_PATH }}
            dotnet restore ${{ env.PROJECT_ANALYZER_PATH }}
            dotnet restore ${{ env.TEST_PROJECT_PATH }}

        - name: Build
          run: |
            dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore /p:Version=${{ env.VERSION }}
            dotnet build ${{ env.PROJECT_ANALYZER_PATH }} --configuration Release --no-restore /p:Version=${{ env.VERSION }}

        - name: Test
          run: |
            dotnet test ${{ env.TEST_PROJECT_PATH }} --configuration Release --no-restore /p:Version=${{ env.VERSION }}

        # ---------------- PACK ----------------

        - name: Pack
          run: |
            mkdir -p ${{ env.PACKAGE_OUTPUT_DIRECTORY }}
            
            dotnet pack ${{ env.PROJECT_PATH }} \
              --configuration Release \
              --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }} \
              /p:Version=${{ env.VERSION }}
            
            dotnet pack ${{ env.PROJECT_ANALYZER_PATH }} \
              --configuration Release \
              --output ${{ env.PACKAGE_OUTPUT_DIRECTORY }} \
              /p:Version=${{ env.VERSION }}

        - name: List packages
          run: ls -la ${{ env.PACKAGE_OUTPUT_DIRECTORY }}

        # ---------------- PUBLISH ----------------

        - name: Authenticate GitHub Packages
          run: |
            dotnet nuget remove source github || true
            dotnet nuget add source \
              --name github \
              --username ${{ github.actor }} \
              --password ${{ secrets.GITHUB_TOKEN }} \
              --store-password-in-clear-text \
              ${{ env.GITHUB_NUGET_SOURCE }}

        - name: Publish to GitHub Packages
          run: |
            dotnet nuget push ${{ env.PACKAGE_OUTPUT_DIRECTORY }}/*.nupkg \
              --source github \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --skip-duplicate

        # ---------------- DORA ----------------

        - name: Start deployment
          if: startsWith(github.ref, 'refs/tags/')
          uses: bobheadxi/deployments@v1
          with:
            step: start
            token: ${{ secrets.GITHUB_TOKEN }}
            ref: ${{ github.ref }}

        - name: Finish deployment (success)
          if: success() && startsWith(github.ref, 'refs/tags/')
          uses: bobheadxi/deployments@v1
          with:
            step: finish
            token: ${{ secrets.GITHUB_TOKEN }}
            status: success
            ref: ${{ github.ref }}

        - name: Finish deployment (failure)
          if: failure() && startsWith(github.ref, 'refs/tags/')
          uses: bobheadxi/deployments@v1
          with:
            step: finish
            token: ${{ secrets.GITHUB_TOKEN }}
            status: failure
            ref: ${{ github.ref }}